# VisualDebugger Backend

## ğŸ–¥ï¸ Backend API Server

NestJS backend nháº­n debug events tá»« SDK vÃ  stream Ä‘áº¿n Frontend dashboard.

---

## ğŸš€ Quick Start

```bash
# Install dependencies
npm install

# Setup database
npx prisma generate
npx prisma migrate dev

# Run development server
npm run start:dev
```

---

## ğŸ“ Cáº¥u trÃºc thÆ° má»¥c

```
VisualDebuggerBE/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                      # Application entry point
â”‚   â”œâ”€â”€ app.module.ts                # Root module
â”‚   â”‚
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ decorators/
â”‚   â”‚   â”‚   â””â”€â”€ api-key.decorator.ts # @ApiKey() decorator
â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”‚   â””â”€â”€ api-key.guard.ts     # API Key authentication guard
â”‚   â”‚   â”œâ”€â”€ filters/
â”‚   â”‚   â”‚   â””â”€â”€ http-exception.filter.ts
â”‚   â”‚   â”œâ”€â”€ interceptors/
â”‚   â”‚   â”‚   â””â”€â”€ transform.interceptor.ts
â”‚   â”‚   â”œâ”€â”€ pipes/
â”‚   â”‚   â”‚   â””â”€â”€ validation.pipe.ts
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚       â”œâ”€â”€ pagination.dto.ts
â”‚   â”‚       â””â”€â”€ response.dto.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.module.ts
â”‚   â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”‚   â”œâ”€â”€ redis.config.ts
â”‚   â”‚   â””â”€â”€ cors.config.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts   # Login, register
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ api-key.strategy.ts
â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚       â”œâ”€â”€ login.dto.ts
â”‚   â”‚   â”‚       â””â”€â”€ register.dto.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ users.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚       â””â”€â”€ user.dto.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ projects/
â”‚   â”‚   â”‚   â”œâ”€â”€ projects.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ projects.controller.ts  # CRUD projects
â”‚   â”‚   â”‚   â”œâ”€â”€ projects.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚       â”œâ”€â”€ create-project.dto.ts
â”‚   â”‚   â”‚       â””â”€â”€ project.dto.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ debug/
â”‚   â”‚   â”‚   â”œâ”€â”€ debug.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ debug.controller.ts     # Receive events from SDK
â”‚   â”‚   â”‚   â”œâ”€â”€ debug.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ debug.gateway.ts        # WebSocket gateway
â”‚   â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚   â”‚       â”œâ”€â”€ create-session.dto.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ create-event.dto.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ session.dto.ts
â”‚   â”‚   â”‚       â””â”€â”€ event.dto.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ sessions/
â”‚   â”‚       â”œâ”€â”€ sessions.module.ts
â”‚   â”‚       â”œâ”€â”€ sessions.controller.ts  # List/get sessions for FE
â”‚   â”‚       â”œâ”€â”€ sessions.service.ts
â”‚   â”‚       â””â”€â”€ dto/
â”‚   â”‚           â””â”€â”€ session-filter.dto.ts
â”‚   â”‚
â”‚   â””â”€â”€ prisma/
â”‚       â”œâ”€â”€ prisma.module.ts
â”‚       â””â”€â”€ prisma.service.ts
â”‚
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma                # Database schema
â”‚   â”œâ”€â”€ migrations/                  # Migration files
â”‚   â””â”€â”€ seed.ts                      # Seed data
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ app.e2e-spec.ts
â”‚   â”œâ”€â”€ debug.e2e-spec.ts
â”‚   â””â”€â”€ jest-e2e.json
â”‚
â”œâ”€â”€ .env.example
â”œâ”€â”€ .env
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.build.json
â”œâ”€â”€ nest-cli.json
â””â”€â”€ README.md
```

---

## ğŸ—„ï¸ Database Schema (PostgreSQL)

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  projects     Project[]
  
  @@map("users")
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  apiKey      String   @unique @map("api_key")
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions DebugSession[]
  
  @@map("projects")
}

model DebugSession {
  id          String    @id @default(uuid())
  projectId   String    @map("project_id")
  environment String    @default("development")
  userAgent   String?   @map("user_agent")
  ipAddress   String?   @map("ip_address")
  metadata    Json?
  startedAt   DateTime  @default(now()) @map("started_at")
  endedAt     DateTime? @map("ended_at")
  
  project Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events  DebugEvent[]
  
  @@index([projectId])
  @@index([startedAt])
  @@map("debug_sessions")
}

model DebugEvent {
  id            String   @id @default(uuid())
  sessionId     String   @map("session_id")
  parentEventId String?  @map("parent_event_id")
  
  // Event info
  type          String   // function_enter, function_exit, http_request, etc.
  name          String?  // Function name or custom name
  
  // Source location
  filePath      String?  @map("file_path")
  lineNumber    Int?     @map("line_number")
  columnNumber  Int?     @map("column_number")
  
  // Data
  arguments     Json?
  returnValue   Json?    @map("return_value")
  errorMessage  String?  @map("error_message")
  errorStack    String?  @map("error_stack")
  
  // HTTP specific
  httpMethod    String?  @map("http_method")
  httpUrl       String?  @map("http_url")
  httpStatus    Int?     @map("http_status")
  httpRequest   Json?    @map("http_request")
  httpResponse  Json?    @map("http_response")
  
  // Timing
  duration      Int?     // milliseconds
  depth         Int      @default(0)
  
  // Metadata
  metadata      Json?
  timestamp     DateTime @default(now())
  
  session     DebugSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  parentEvent DebugEvent?  @relation("EventHierarchy", fields: [parentEventId], references: [id])
  childEvents DebugEvent[] @relation("EventHierarchy")
  
  @@index([sessionId])
  @@index([timestamp])
  @@index([type])
  @@map("debug_events")
}
```

---

## ğŸ”Œ API Endpoints

### Authentication

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/auth/register` | Register new user | - |
| POST | `/api/auth/login` | Login, get JWT | - |
| GET | `/api/auth/me` | Get current user | JWT |

### Projects

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/projects` | List user's projects | JWT |
| POST | `/api/projects` | Create new project | JWT |
| GET | `/api/projects/:id` | Get project details | JWT |
| PATCH | `/api/projects/:id` | Update project | JWT |
| DELETE | `/api/projects/:id` | Delete project | JWT |
| POST | `/api/projects/:id/regenerate-key` | Regenerate API key | JWT |

### Debug (SDK endpoints)

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | `/api/debug/session` | Start debug session | API Key |
| PATCH | `/api/debug/session/:id` | End session | API Key |
| POST | `/api/debug/events` | Send debug events (batch) | API Key |
| POST | `/api/debug/event` | Send single event | API Key |

### Sessions (Dashboard endpoints)

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| GET | `/api/sessions` | List debug sessions | JWT |
| GET | `/api/sessions/:id` | Get session with events | JWT |
| GET | `/api/sessions/:id/events` | Get session events (paginated) | JWT |
| DELETE | `/api/sessions/:id` | Delete session | JWT |

### WebSocket

| Event | Direction | Description |
|-------|-----------|-------------|
| `subscribe` | Client â†’ Server | Subscribe to project's events |
| `unsubscribe` | Client â†’ Server | Unsubscribe |
| `new_session` | Server â†’ Client | New session started |
| `new_event` | Server â†’ Client | New debug event |
| `session_ended` | Server â†’ Client | Session ended |

---

## ğŸ” Environment Variables

```bash
# .env

# Database
DATABASE_URL="postgresql://user:password@localhost:5432/visual_debugger?schema=public"

# Redis (for WebSocket scaling)
REDIS_URL="redis://localhost:6379"

# JWT
JWT_SECRET="your-super-secret-jwt-key"
JWT_EXPIRES_IN="7d"

# Server
PORT=3001
NODE_ENV="development"

# CORS
CORS_ORIGINS="http://localhost:3000"
```

---

## ğŸ“¡ WebSocket Gateway

```typescript
// debug.gateway.ts - Simplified example

@WebSocketGateway({
  cors: { origin: process.env.CORS_ORIGINS },
  namespace: '/debug'
})
export class DebugGateway {
  @WebSocketServer()
  server: Server;

  @SubscribeMessage('subscribe')
  handleSubscribe(client: Socket, projectId: string) {
    client.join(`project:${projectId}`);
  }

  // Called by DebugService when new event received
  broadcastEvent(projectId: string, event: DebugEvent) {
    this.server.to(`project:${projectId}`).emit('new_event', event);
  }
}
```

---

## ğŸš€ Deployment

### Docker

```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npx prisma generate
RUN npm run build

EXPOSE 3001

CMD ["node", "dist/main.js"]
```

### Docker Compose

```yaml
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/visual_debugger
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: visual_debugger
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine

volumes:
  postgres_data:
```
